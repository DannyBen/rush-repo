#!/usr/bin/env bash
set -e

if [[ $# == 0 ]] || ([[ $# == 1 ]] && [[ -z "$RUSH_REPO" ]]); then
  printf "Usage:\n"
  printf "  rush USER PACKAGE\n"
  if [[ -n "$RUSH_REPO" ]]; then
    printf "  rush PACKAGE\n"
  fi
  printf "\nWhere:\n"
  printf "  USER is a GitHub user or a full URL to any site, and\n"
  printf "  PACKAGE is a name of a package from the user's rush repository\n\n"
  if [[ -z "$RUSH_REPO" ]]; then
    printf "USER can be omitted if it is set in the RUSH_REPO environment variable\n\n"
  else
    printf "When USER is not provided, it will default to:\n"
    printf "  $RUSH_REPO (as specified by RUSH_REPO)\n\n"
  fi
  exit 1
fi

if [[ $# == 2 ]]; then
  repo=$1
  pack=$2
else
  repo=$RUSH_REPO
  pack=$1
fi

printf "\nRushing $repo/$pack\n"

if [[ $repo =~ ':' ]]; then
  base="$repo"
else
  base="https://raw.githubusercontent.com/$repo/rush/master"
fi

export SELF="$base/$pack"

wget -qO- $SELF/main | bash

if [[ $? != 0 ]]; then
  echo "Finished with errors (exit code $?)"
fi

