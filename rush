#!/usr/bin/env bash
set -o pipefail

if [[ $# == 0 ]] || ([[ $# == 1 ]] && [[ -z "$RUSH_REPO" ]]); then
  printf "Usage:\n"
  printf "  rush REPO PACKAGE\n"
  if [[ -n "$RUSH_REPO" ]]; then
    printf "  rush PACKAGE\n"
  fi
  printf "\nParameters:\n"
  printf "  REPO     either a GitHub user or a full URL to any site\n"
  printf "  PACKAGE  a name of a package from the user's rush repository\n\n"
  if [[ -z "$RUSH_REPO" ]]; then
    printf "REPO can be omitted if it is set in the RUSH_REPO environment variable\n\n"
  else
    printf "When REPO is not provided, it will default to:\n"
    printf "  $RUSH_REPO (as specified by RUSH_REPO)\n\n"
  fi
  exit 1
fi

if [[ $# == 2 ]]; then
  repo=$1
  pack=$2
else
  repo=$RUSH_REPO
  pack=$1
fi

printf "\nRushing $repo/$pack\n"

if [[ $repo =~ ':' ]]; then
  base="$repo"
else
  base="https://raw.githubusercontent.com/$repo/rush/master"
fi

export SELF="$base/$pack"

wget -qO- $SELF/main | bash
exitcode=$?

if [[ "$exitcode" != "0" ]]; then
  echo "Error $exitcode @ $SELF"
fi

